{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Dhaka Bus Assistance</title>

    <link rel="stylesheet" href="{% static 'transport/style.css' %}">
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
<div class="container">
    <h1>üöç Dhaka Bus Assistance</h1>

    <!-- SEARCH -->
    <div class="search-box">
        <form method="get">
            <label>From Stop</label>
            <select name="from_stop" required>
                <option value="">Select start</option>
                {% for stop in stops %}
                    <option value="{{ stop.id }}"
                        {% if selected_from and stop.id == selected_from.id %}selected{% endif %}>
                        {{ stop.name }}
                    </option>
                {% endfor %}
            </select>

            <label>To Stop</label>
            <select name="to_stop" required>
                <option value="">Select destination</option>
                {% for stop in stops %}
                    <option value="{{ stop.id }}"
                        {% if selected_to and stop.id == selected_to.id %}selected{% endif %}>
                        {{ stop.name }}
                    </option>
                {% endfor %}
            </select>

            <button type="submit">Search</button>
        </form>
    </div>

    <!-- MAP -->
    <div id="map" style="height: 400px; margin-bottom: 30px;"></div>

    <!-- RESULTS -->
    {% if routes_found %}
        {% for item in routes_found %}
            <div class="route-card">
                <h3>{{ item.route.name }}</h3>
                <p class="fare">Fare: {{ item.fare }} BDT</p>

                <ul>
                    {% for bus in item.route.buses.all %}
                        <li>{{ bus.name }} ({{ bus.bus_number }})</li>
                    {% endfor %}
                </ul>
            </div>
        {% endfor %}
    {% endif %}
</div>

<!-- SAFE DATA TRANSFER -->
{{ map_stops|json_script:"map-stops-data" }}

<script>
    const map = L.map('map').setView([23.8103, 90.4125], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const stops = JSON.parse(
        document.getElementById("map-stops-data").textContent
    );

    if (stops.length > 0) {
        let latlngs = [];

        stops.forEach(stop => {
            latlngs.push([stop.lat, stop.lng]);
            L.marker([stop.lat, stop.lng]).addTo(map).bindPopup(stop.name);
        });

        const line = L.polyline(latlngs, {color: "blue"}).addTo(map);
        map.fitBounds(line.getBounds());
    }
</script>

</body>
</html>
